# 中间件

Cowboy将请求处理委托给中间件组件。 默认情况下，定义了两个中间件，用于路由和处理请求，本指南的大部分内容对此进行了详细介绍。

中间件使您可以完全控制如何处理请求。 您可以根据需要添加自己的中间件或完全更改中间件链。

Cowboy将以给定的顺序执行所有中间件，除非其中一个决定停止处理。

## 用法

中间件只需要实现一个回调：execute/2。 它在cowboy_middleware行为中定义。

这个回调有两个参数。 第一个是Req对象。 第二是environment。

中间件可以返回三个不同值中的一个：

- {ok，Req，Env} 继续请求处理
- {suspend，Module，Function，Args} 休眠
- {stop，Req} 停止处理并继续下一个请求

值得注意的是，当休眠时，处理将在给定的MFA上恢复，丢弃所有先前的堆栈跟踪。 确保将Req和Env保留在此MFA的参数中以供日后使用。

如果在中间件处理期间发生错误，Cowboy将不会尝试将错误发送回套接字，该过程将崩溃。 如果出现问题，应由中间件确保发送回复。

## 配置

中间件环境定义为env协议选项。 在前面的章节中，我们在需要传递路由信息时简要地看到了它。 它是一个元组列表，第一个元素是原子，第二个是Erlang术语。

保留环境中的两个值：

- listener 包含侦听器的名称
- result 包含处理结果

始终定义侦听器值。 结果值可以由任何中间件设置。 如果设置为ok以外的任何其他内容，Cowboy将不会处理此连接上的任何后续请求。

Cowboy附带的中间件可能会定义或要求执行其他环境值。

您可以通过调用cowboy:set_env/3便捷功能，在环境中添加或替换值来更新环境。

## Routing 中间件

路由中间件需要调度值。 如果路由成功，它将分别将处理程序名称和选项放在环境的handler和handler_opts值中。

## 处理程序中间件

处理程序中间件需要handler和handler_opts值。 它将请求处理的结果放入result中。

